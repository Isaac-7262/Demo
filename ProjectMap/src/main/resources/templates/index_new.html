<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ - ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        :root {
            --kku-primary: #8B4513;      /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏Ç‡∏≠‡∏á ‡∏°‡∏Ç. */
            --kku-secondary: #D2691E;     /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏ó‡∏≠‡∏á */
            --kku-light: #F5E6D3;        /* ‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡∏≠‡πà‡∏≠‡∏ô */
            --kku-dark: #654321;         /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏Ç‡πâ‡∏° */
            --kku-accent: #FF8C00;       /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏™‡∏î */
        }

        * {
            font-family: 'Prompt', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--kku-light) 0%, #fff 100%);
            min-height: 100vh;
        }

        .navbar-kku {
            background: linear-gradient(45deg, var(--kku-primary) 0%, var(--kku-secondary) 100%);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: white !important;
            font-size: 1.5rem;
        }

        .kku-logo {
            width: 45px;
            height: 45px;
            margin-right: 10px;
        }

        .map-container {
            height: 70vh;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 3px solid var(--kku-secondary);
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid var(--kku-light);
        }

        .btn-kku-primary {
            background: linear-gradient(45deg, var(--kku-primary) 0%, var(--kku-secondary) 100%);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-kku-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }

        .btn-report {
            background: linear-gradient(45deg, #dc3545 0%, #fd7e14 100%);
            border: none;
            color: white;
            border-radius: 50px;
            padding: 15px 30px;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 5px 20px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
        }

        .btn-report:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
            color: white;
        }

        .incident-type-btn {
            margin: 0.25rem;
            border-radius: 20px;
            border: 2px solid var(--kku-light);
            background: white;
            color: var(--kku-dark);
            transition: all 0.3s ease;
        }

        .incident-type-btn:hover,
        .incident-type-btn.active {
            background: var(--kku-secondary);
            color: white;
            border-color: var(--kku-secondary);
            transform: scale(1.05);
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid var(--kku-light);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--kku-primary);
            margin-bottom: 0;
        }

        .stats-label {
            color: var(--kku-dark);
            font-weight: 600;
            margin-top: 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-pending { background-color: #dc3545; }
        .status-progress { background-color: #ffc107; }
        .status-resolved { background-color: #28a745; }

        .modal-header-kku {
            background: linear-gradient(45deg, var(--kku-primary) 0%, var(--kku-secondary) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid var(--kku-light);
            padding: 0.75rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--kku-secondary);
            box-shadow: 0 0 0 0.2rem rgba(210, 105, 30, 0.25);
        }

        .alert-kku {
            border-radius: 15px;
            border: none;
            padding: 1rem 1.5rem;
        }

        .footer-kku {
            background: var(--kku-dark);
            color: var(--kku-light);
            padding: 2rem 0;
            margin-top: 3rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .map-container {
                height: 50vh;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .kku-logo {
                width: 35px;
                height: 35px;
            }
            
            .btn-report {
                width: 100%;
                margin-bottom: 1rem;
            }
        }

        /* Custom marker styles */
        .incident-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .marker-accident { background-color: #dc3545; }
        .marker-medical { background-color: #17a2b8; }
        .marker-conflict { background-color: #ffc107; }
        .marker-fire { background-color: #fd7e14; }
        .marker-help { background-color: #6f42c1; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-kku">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/images/kku-logo.png" alt="KKU" class="kku-logo" 
                     onerror="this.style.display='none'">
                <div>
                    <div>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</div>
                    <small style="font-size: 0.8rem; opacity: 0.9;">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</small>
                </div>
            </a>
            
            <div class="d-flex align-items-center">
                <a href="/dashboard" class="btn btn-outline-light me-2">
                    <i class="fas fa-chart-line"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                </a>
                <span class="badge bg-light text-dark me-2">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    <span id="activeIncidents" th:text="${activeIncidentsCount}">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <!-- Control Panel -->
            <div class="col-lg-3 col-md-4">
                <div class="control-panel">
                    <h5 class="mb-3">
                        <i class="fas fa-plus-circle text-danger"></i>
                        ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
                    </h5>
                    
                    <button class="btn btn-report w-100" data-bs-toggle="modal" data-bs-target="#reportModal">
                        <i class="fas fa-map-marker-alt"></i>
                        ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏î‡πà‡∏ß‡∏ô
                    </button>
                    
                    <hr class="my-4">
                    
                    <h6 class="mb-3">
                        <i class="fas fa-filter"></i>
                        ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                    </h6>
                    
                    <div class="incident-filters">
                        <button class="btn incident-type-btn active" data-type="all">
                            <i class="fas fa-globe"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button class="btn incident-type-btn" data-type="accident">
                            <i class="fas fa-car-crash"></i> ‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏
                        </button>
                        <button class="btn incident-type-btn" data-type="medical">
                            <i class="fas fa-heartbeat"></i> ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
                        </button>
                        <button class="btn incident-type-btn" data-type="conflict">
                            <i class="fas fa-fist-raised"></i> ‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó
                        </button>
                        <button class="btn incident-type-btn" data-type="fire">
                            <i class="fas fa-fire"></i> ‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ
                        </button>
                        <button class="btn incident-type-btn" data-type="help">
                            <i class="fas fa-hands-helping"></i> ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-card">
                    <div class="stats-number" id="totalIncidents">0</div>
                    <div class="stats-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>

                <div class="stats-card">
                    <div class="stats-number text-danger" id="activeCount">0</div>
                    <div class="stats-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                </div>
            </div>

            <!-- Map Area -->
            <div class="col-lg-9 col-md-8">
                <div class="control-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-map"></i>
                            ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå - ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
                        </h5>
                        <div>
                            <span class="status-indicator status-pending"></span> ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                            <span class="status-indicator status-progress"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                            <span class="status-indicator status-resolved"></span> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                        </div>
                    </div>
                    
                    <div id="map" class="map-container"></div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 15px; border: none;">
                <div class="modal-header modal-header-kku">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reportForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-tag"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *
                                </label>
                                <select class="form-select" id="incidentType" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</option>
                                    <option value="accident">üöó ‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</option>
                                    <option value="medical">üè• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
                                    <option value="conflict">‚öîÔ∏è ‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó</option>
                                    <option value="fire">üî• ‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ</option>
                                    <option value="help">üôã ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-exclamation"></i> ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
                                </label>
                                <select class="form-select" id="severityLevel">
                                    <option value="‡∏õ‡∏Å‡∏ï‡∏¥">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                    <option value="‡∏î‡πà‡∏ß‡∏ô">üü° ‡∏î‡πà‡∏ß‡∏ô</option>
                                    <option value="‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô">üî¥ ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user"></i> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô *
                                </label>
                                <input type="text" class="form-control" id="reporter" required 
                                       placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≤‡∏°‡πÅ‡∏ù‡∏á">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-phone"></i> ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
                                </label>
                                <input type="text" class="form-control" id="reporterContact" 
                                       placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£, Line ID, ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-map-marker-alt"></i> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="locationDisplay" readonly 
                                       placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">
                                <button type="button" class="btn btn-outline-secondary" id="useCurrentLocation">
                                    <i class="fas fa-crosshairs"></i> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                                </button>
                            </div>
                            <input type="hidden" id="latitude">
                            <input type="hidden" id="longitude">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-comment-alt"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *
                            </label>
                            <textarea class="form-control" id="description" rows="4" required
                                      placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="button" class="btn btn-kku-primary" id="submitReport">
                        <i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Incident Detail Modal -->
    <div class="modal fade" id="incidentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header modal-header-kku">
                    <h5 class="modal-title" id="incidentModalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="incidentModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer-kku">
        <div class="container text-center">
            <div class="row">
                <div class="col-12">
                    <h6>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</h6>
                    <p class="mb-0">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</p>
                    <small class="text-muted">
                        <i class="fas fa-shield-alt"></i> 
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏∏‡πà‡∏á‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let currentMarker;
        let incidentMarkers = [];
        let selectedLat = null;
        let selectedLng = null;
        
        // Map configuration
        const MAP_CONFIG = {
            center: [/*[[${mapLat}]]*/ 16.473, /*[[${mapLng}]]*/ 102.823],
            zoom: /*[[${mapZoom}]]*/ 15
        };

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadIncidents();
            setupEventHandlers();
            updateStats();
            
            // Refresh data every 30 seconds
            setInterval(function() {
                loadIncidents();
                updateStats();
            }, 30000);
        });

        function initializeMap() {
            map = L.map('map').setView(MAP_CONFIG.center, MAP_CONFIG.zoom);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add click event to map for selecting location
            map.on('click', function(e) {
                selectedLat = e.latlng.lat;
                selectedLng = e.latlng.lng;
                
                // Remove existing marker
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                
                // Add new marker
                currentMarker = L.marker([selectedLat, selectedLng], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiNkYzM1NDUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgMkM4LjEzIDIgNSA1LjEzIDUgOWMwIDUuMjUgNyAxMyA3IDEzczctNy43NSA3LTEzYzAtMy44Ny0zLjEzLTctNy03em0wIDkuNWMtMS4zOCAwLTIuNS0xLjEyLTIuNS0yLjVzMS4xMi0yLjUgMi41LTIuNSAyLjUgMS4xMiAyLjUgMi41LTEuMTIgMi41LTIuNSAyLjV6Ii8+PC9zdmc+',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(map);
                
                // Update location display
                document.getElementById('locationDisplay').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
                document.getElementById('latitude').value = selectedLat;
                document.getElementById('longitude').value = selectedLng;
            });
        }

        function loadIncidents() {
            fetch('/api/incidents')
                .then(response => response.json())
                .then(incidents => {
                    // Clear existing markers
                    incidentMarkers.forEach(marker => map.removeLayer(marker));
                    incidentMarkers = [];
                    
                    // Add markers for each incident
                    incidents.forEach(incident => {
                        const marker = createIncidentMarker(incident);
                        incidentMarkers.push(marker);
                        marker.addTo(map);
                    });
                })
                .catch(error => {
                    console.error('Error loading incidents:', error);
                });
        }

        function createIncidentMarker(incident) {
            const typeColors = {
                'accident': '#dc3545',
                'medical': '#17a2b8', 
                'conflict': '#ffc107',
                'fire': '#fd7e14',
                'help': '#6f42c1'
            };

            const color = typeColors[incident.type] || '#6c757d';
            
            const marker = L.circleMarker([incident.latitude, incident.longitude], {
                radius: 10,
                fillColor: color,
                color: 'white',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            });

            // Add popup with incident details
            const popupContent = `
                <div style="min-width: 200px;">
                    <h6><strong>${getTypeDisplayName(incident.type)}</strong></h6>
                    <p><small><i class="fas fa-clock"></i> ${new Date(incident.createdAt).toLocaleString('th-TH')}</small></p>
                    <p>${incident.description}</p>
                    <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span style="color: ${getStatusColor(incident.status)}">${incident.status}</span></p>
                    <button class="btn btn-sm btn-primary" onclick="showIncidentDetails(${incident.id})">
                        ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            return marker;
        }

        function getTypeDisplayName(type) {
            const types = {
                'accident': '‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏',
                'medical': '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
                'conflict': '‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó',
                'fire': '‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ',
                'help': '‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠'
            };
            return types[type] || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
        }

        function getStatusColor(status) {
            switch(status) {
                case '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': return '#dc3545';
                case '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': return '#ffc107';  
                case '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß': return '#28a745';
                default: return '#6c757d';
            }
        }

        function setupEventHandlers() {
            // Submit report form
            document.getElementById('submitReport').addEventListener('click', function() {
                submitIncidentReport();
            });

            // Use current location button
            document.getElementById('useCurrentLocation').addEventListener('click', function() {
                getCurrentLocation();
            });

            // Filter buttons
            document.querySelectorAll('.incident-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.incident-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterIncidents(this.dataset.type);
                });
            });
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    selectedLat = position.coords.latitude;
                    selectedLng = position.coords.longitude;
                    
                    // Update map
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }
                    
                    currentMarker = L.marker([selectedLat, selectedLng]).addTo(map);
                    map.setView([selectedLat, selectedLng], 16);
                    
                    // Update form
                    document.getElementById('locationDisplay').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
                    document.getElementById('latitude').value = selectedLat;
                    document.getElementById('longitude').value = selectedLng;
                    
                }, function(error) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ: ' + error.message);
                });
            } else {
                alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
            }
        }

        function submitIncidentReport() {
            const formData = {
                type: document.getElementById('incidentType').value,
                severityLevel: document.getElementById('severityLevel').value,
                description: document.getElementById('description').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                reporter: document.getElementById('reporter').value,
                reporterContact: document.getElementById('reporterContact').value
            };

            // Validation
            if (!formData.type || !formData.description || !formData.latitude || !formData.longitude || !formData.reporter) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            fetch('/api/incidents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                    modal.hide();
                    
                    // Reset form
                    document.getElementById('reportForm').reset();
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                        currentMarker = null;
                    }
                    selectedLat = selectedLng = null;
                    document.getElementById('locationDisplay').value = '';
                    
                    // Refresh data
                    loadIncidents();
                    updateStats();
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            });
        }

        function updateStats() {
            fetch('/api/incidents/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalIncidents').textContent = data.totalIncidents || 0;
                    document.getElementById('activeCount').textContent = data.activeIncidents || 0;
                    document.getElementById('activeIncidents').textContent = data.activeIncidents || 0;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        function filterIncidents(type) {
            incidentMarkers.forEach(marker => {
                map.removeLayer(marker);
            });

            const endpoint = type === 'all' ? '/api/incidents' : `/api/incidents/type/${type}`;
            
            fetch(endpoint)
                .then(response => response.json())
                .then(incidents => {
                    incidentMarkers = [];
                    incidents.forEach(incident => {
                        const marker = createIncidentMarker(incident);
                        incidentMarkers.push(marker);
                        marker.addTo(map);
                    });
                })
                .catch(error => {
                    console.error('Error filtering incidents:', error);
                });
        }

        function showIncidentDetails(incidentId) {
            fetch(`/api/incidents/${incidentId}`)
                .then(response => response.json())
                .then(incident => {
                    const modalBody = document.getElementById('incidentModalBody');
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h6>
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong></td>
                                        <td>${getTypeDisplayName(incident.type)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong></td>
                                        <td><span style="color: ${getStatusColor(incident.status)}">${incident.status}</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á:</strong></td>
                                        <td>${incident.severityLevel}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong></td>
                                        <td>${incident.reporter}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong></td>
                                        <td>${new Date(incident.createdAt).toLocaleString('th-TH')}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong></td>
                                        <td>${incident.description}</td>
                                    </tr>
                                    ${incident.officerNotes ? `
                                    <tr>
                                        <td><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</strong></td>
                                        <td>${incident.officerNotes}</td>
                                    </tr>
                                    ` : ''}
                                </table>
                                
                                <div class="mt-3">
                                    <button class="btn btn-primary btn-sm" onclick="focusOnIncident(${incident.latitude}, ${incident.longitude})">
                                        <i class="fas fa-map-marker-alt"></i> ‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const modal = new bootstrap.Modal(document.getElementById('incidentModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading incident details:', error);
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ');
                });
        }

        function focusOnIncident(lat, lng) {
            map.setView([lat, lng], 17);
            const modal = bootstrap.Modal.getInstance(document.getElementById('incidentModal'));
            modal.hide();
        }
    </script>
</body>
</html>